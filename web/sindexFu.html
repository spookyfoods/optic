<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WebPPM Studio - WASM based artifact restoration tool">
    <title>WebPPM Studio | Artifact Restoration</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Drag and drop visual cue */
        .drag-active {
            background-color: #f0f8ff;
            outline: 4px dashed #666;
            transition: all 0.2s ease;
        }

        /* Prevent child elements from firing dragleave events */
        #drop-zone img {
            pointer-events: none;
        }

        /* Spinner for processing state */
        .processing-overlay {
            cursor: wait;
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Security warning banner */
        #security-warning {
            background-color: #ffcccc;
            color: #990000;
            padding: 10px;
            text-align: center;
            display: none; /* Hidden by default */
            border-bottom: 1px solid #cc0000;
        }
    </style>
</head>

<body>

    <div id="security-warning">
        <strong>⚠️ Threading Error:</strong> This page is not Cross-Origin Isolated. 
        WebAssembly Threads will crash. You must serve this page with headers: 
        <code>Cross-Origin-Opener-Policy: same-origin</code> and 
        <code>Cross-Origin-Embedder-Policy: require-corp</code>.
    </div>

    <main>
        <h1>WebPPM Restoration Site</h1>

        <div id="metrics">
            <ul>
                <li>Status: <span id="status-val">Initializing Worker...</span></li>
                <li>Dimensions: <span id="dims-val">N/A</span></li>
            </ul>
        </div>

        <section id="controls">
            <fieldset>
                <legend>Excavation Controls</legend>

                <label for="file-upload">Select Artifact (or Drag & Drop):</label>
                <input type="file" id="file-upload" accept="image/*" disabled>

                <hr>

                <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 10px;">
                    <div>
                        <label for="filter-type">Restoration Method:</label>
                        <select id="filter-type">
                            <option value="sat">SAT Box Blur (Fast)</option>
                            <option value="naive">Naive Box Blur (Slow)</option>
                        </select>
                    </div>
                </div>

                <div class="slider-container">
                    <label for="filter-slider">Restoration Intensity: <strong id="slider-display">1</strong></label>
                    <input type="range" id="filter-slider" min="1" max="25" step="2" value="1">
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" id="btn-process" disabled><strong>PROCESS ARTIFACT</strong></button>
                    <button type="button" id="btn-download-img" disabled><strong>SAVE IMAGE</strong></button>
                </div>
            </fieldset>
        </section>

        <section id="workspace">
            <table width="100%">
                <thead>
                    <tr>
                        <th>Raw Clay (Source)</th>
                        <th>Fired Brick (Result)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td align="center" valign="middle" id="drop-zone">
                            <img id="source-image" alt="Waiting for input..."
                                style="max-height: 400px; max-width: 100%; transition: 0.3s;" />
                        </td>

                        <td align="center" valign="middle">
                            <canvas id="output-canvas"></canvas>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="logs">
            <h3>Excavation Log</h3>
            <textarea id="console-log" rows="8" readonly></textarea>
        </section>
    </main>

    <footer>
        WebPPM Studio // Experimental WASM Build // v2.3 Worker Edition
    </footer>

    <script>
        // --- Global State ---
        // Initialize the Worker immediately. 
        // Ensure worker.js is in the same directory.
        const worker = new Worker('worker.js');

        // UI Elements
        const fileInput = document.getElementById('file-upload');
        const dropZone = document.getElementById('drop-zone');
        const btnProcess = document.getElementById('btn-process');
        const btnDownloadImg = document.getElementById('btn-download-img');
        const statusVal = document.getElementById('status-val');
        const dimsVal = document.getElementById('dims-val');
        const consoleLog = document.getElementById('console-log');
        const sourceImage = document.getElementById('source-image');
        const canvas = document.getElementById('output-canvas');
        const ctx = canvas.getContext('2d');
        const slider = document.getElementById('filter-slider');
        const sliderDisplay = document.getElementById('slider-display');
        const filterTypeSelect = document.getElementById('filter-type');
        const warningBanner = document.getElementById('security-warning');

        // --- Helper: Logger ---
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleLog.value += `[${timestamp}] ${message}\n`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        // --- Step 0: Security Check ---
        if (!window.crossOriginIsolated) {
            warningBanner.style.display = 'block';
            log("⚠️ CRITICAL: Page is not Cross-Origin Isolated.");
            log("   Multi-threading will fail. See banner for fix.");
            statusVal.textContent = "Security Error";
        }

        // --- Step 1: Worker Communication Handler ---
        worker.onmessage = function(e) {
            const { type, payload } = e.data;

            switch (type) {
                case 'READY':
                    statusVal.textContent = "Engine Ready";
                    fileInput.disabled = false;
                    log("System: Worker initialized successfully.");
                    break;

                case 'IMAGE_LOADED':
                    // e.data contains width/height directly
                    statusVal.textContent = "Image Loaded";
                    dimsVal.textContent = `${e.data.width} x ${e.data.height}`;
                    btnProcess.disabled = false;
                    log(`System: Image loaded in Worker (${e.data.width}x${e.data.height}).`);
                    break;

                case 'RENDER':
                    // Payload contains: pixels (Uint8ClampedArray), width, height
                    renderCanvas(e.data.pixels, e.data.width, e.data.height);
                    break;

                case 'FILTER_DONE':
                    statusVal.textContent = "Done";
                    btnDownloadImg.disabled = false;
                    document.body.classList.remove('processing-overlay');
                    log("System: Processing complete.");
                    break;

                case 'ERROR':
                    statusVal.textContent = "Error";
                    document.body.classList.remove('processing-overlay');
                    log("Worker Error: " + e.data.message);
                    break;
            }
        };

        worker.onerror = function(err) {
            log("Worker Infrastructure Error: " + err.message);
        };

        slider.addEventListener('input', (e) => sliderDisplay.textContent = e.target.value);

        // --- Step 2: Handle File Loading ---
        async function loadFile(file) {
            if (!file) return;

            statusVal.textContent = "Uploading...";
            btnProcess.disabled = true;
            btnDownloadImg.disabled = true;
            sourceImage.src = URL.createObjectURL(file);

            try {
                const arrayBuffer = await file.arrayBuffer();
                log(`System: Sending ${file.name} to Worker...`);
                
                // Send the raw bytes to the worker. 
                // We use the 2nd argument (transferable) to move ownership effectively.
                worker.postMessage({ 
                    type: 'LOAD_IMAGE', 
                    payload: arrayBuffer 
                }, [arrayBuffer]);

            } catch (err) {
                log("System Error: " + err.message);
                statusVal.textContent = "Error";
            }
        }

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) loadFile(e.target.files[0]);
        });

        // --- Step 3: Drag and Drop Logic ---
        function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
            });

            ['dragleave', 'drop'].forEach
